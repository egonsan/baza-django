{% extends "sprzet/base.html" %}
{% block content %}

<div class="eq-detail">
  <div class="panel">
    <div class="panel-header">
      <div>
        <h1>Szczegóły sprzętu</h1>
        <p class="subtitle">
          Nr inwentarzowy: <span class="chip">{{ equipment.inventory_number|default:"—" }}</span>
        </p>
      </div>

      <div class="actions">
        <a class="btn btn-secondary" href="{% url 'equipment:equipment_list' %}">Wróć do magazynu</a>
        <a class="btn btn-primary" href="{% url 'equipment:equipment_edit' equipment.pk %}">Edytuj</a>
      </div>
    </div>

    <div class="grid">

      <!-- LEWA: DANE -->
      <div>
        <table class="detail-table">
          <tbody>
            <tr><th>Nr inwentarzowy</th><td>{{ equipment.inventory_number|default:"—" }}</td></tr>
            <tr><th>Nazwa</th><td>{{ equipment.equipment_name|default:"—" }}</td></tr>
            <tr><th>Typ sprzętu</th><td>{{ equipment.equipment_type|default:"—" }}</td></tr>
            <tr><th>Status</th><td>{{ equipment.status|default:"—" }}</td></tr>
            <tr><th>Budynek</th><td>{{ equipment.building|default:"—" }}</td></tr>
            <tr><th>Pomieszczenie</th><td>{{ equipment.room|default:"—" }}</td></tr>
            <tr><th>Kategoria</th><td>{{ equipment.room_category|default:"—" }}</td></tr>

            <tr><th>Użytkownik</th><td>{{ equipment.user_full_name|default:"—" }}</td></tr>
            <tr><th>Wypożyczone do</th><td>{{ equipment.borrowed_to|default:"—" }}</td></tr>

            <tr><th>Hostname</th><td>{{ equipment.hostname|default:"—" }}</td></tr>
            <tr><th>IP</th><td>{{ equipment.ip_address|default:"—" }}</td></tr>
            <tr><th>MAC</th><td>{{ equipment.mac_address|default:"—" }}</td></tr>

            <tr><th>Nr seryjny jednostki</th><td>{{ equipment.unit_serial_number|default:"—" }}</td></tr>
            <tr><th>Nr seryjny monitora</th><td>{{ equipment.monitor_serial_number|default:"—" }}</td></tr>

            <tr><th>System</th><td>{{ equipment.os_name|default:"—" }}{% if equipment.os_version %} ({{ equipment.os_version }}){% endif %}</td></tr>
            <tr><th>Klucz Windows</th><td>{{ equipment.os_serial_key|default:"—" }}</td></tr>

            <tr><th>Office</th><td>{{ equipment.office_name|default:"—" }}{% if equipment.office_version %} ({{ equipment.office_version }}){% endif %}</td></tr>
            <tr><th>Klucz Office</th><td>{{ equipment.office_serial_key|default:"—" }}</td></tr>

            <tr><th>Dostawca</th><td>{{ equipment.supplier|default:"—" }}</td></tr>
            <tr><th>Data zakupu</th><td>{{ equipment.purchase_date|date:"Y-m-d"|default:"—" }}</td></tr>

            <tr>
              <th>Gwarancja do</th>
              <td>
                {% if equipment.warranty_until %}
                  {{ equipment.warranty_until|date:"Y-m-d" }}
                  {% now "U" as now_u %}
                  {% with wu=equipment.warranty_until|date:"U" %}
                    {% if wu >= now_u %}
                      <span class="badge badge-ok">Aktywna</span>
                    {% else %}
                      <span class="badge badge-bad">Wygasła</span>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>

            <tr><th>Uwagi</th><td>{{ equipment.notes|default:"—" }}</td></tr>
          </tbody>
        </table>
      </div>

      <!-- PRAWA: ZAŁĄCZNIKI -->
      <div>
        <div class="card">

          <div class="photo">
            {% if attachments %}
              {% with main_attachment=attachments.0 %}
                <a href="{{ main_attachment.file.url }}" target="_blank">
                  <img src="{{ main_attachment.file.url }}" alt="Zdjęcie sprzętu">
                </a>
              {% endwith %}
            {% else %}
              <div class="photo-placeholder">Brak zdjęcia – dodaj jako załącznik</div>
            {% endif %}
          </div>

          <h2>Załączniki</h2>

          <div class="attachments">
            {% if attachments %}
              {% for att in attachments %}
                <div class="att-item">
                  <div class="att-left">
                    <div class="att-name">
                      <a href="{{ att.file.url }}" target="_blank">
                        {{ att.description|default:"Załącznik" }}
                      </a>
                    </div>
                    <div class="att-meta">
                      Dodano: {{ att.uploaded_at|date:"Y-m-d H:i" }}
                    </div>
                  </div>

                  <div class="att-actions">
                    <form method="post" action="{% url 'equipment:attachment_delete' att.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger btn-xs" onclick="return confirm('Na pewno usunąć załącznik?');">Usuń</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="muted">Brak załączników.</div>
            {% endif %}
          </div>

          <hr style="border:none; border-top:1px solid var(--panel-border); margin:14px 0;">

          <form class="form-grid" method="post" enctype="multipart/form-data" action="{% url 'equipment:attachment_upload' equipment.pk %}">
            {% csrf_token %}

            <div class="field">
              <label for="id_file">Plik</label>
              <input id="id_file" type="file" name="file" required>
            </div>

            <div class="field">
              <label for="id_desc">Opis (opcjonalnie)</label>
              <input id="id_desc" type="text" name="description" placeholder="Np. faktura, zdjęcie tabliczki, protokół…">
            </div>

            <div class="actions">
              <button type="submit" class="btn btn-primary">Dodaj załącznik</button>
            </div>

            <div class="note">
              Załączniki są przypisane do tej karty sprzętu i widoczne w szczegółach.
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}
